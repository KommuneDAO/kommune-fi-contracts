╔══════════════════════════════════════════════════════════════╗
║     KOMMUNEFI V2 - STABLE MODE INTEGRATED TEST              ║
╚══════════════════════════════════════════════════════════════╝

📋 Test Plan:
  1. Deploy fresh contracts with STABLE profile
  2. Test with 3 wallets - deposit & withdraw
  3. Test unstake & claim (optional)
  4. Verify LST distribution

💰 Checking wallet balances...
  Wallet 1: 26.047978765730837379 KAIA (need 0.1 KAIA)
  Wallet 2: 276.129980597319063481 KAIA (need 0.01 KAIA)
  Wallet 3: 14.697200528467860854 KAIA (need 0.01 KAIA)
✅ All wallets have sufficient balance

╔══════════════════════════════════════════════════════════════╗
║   STEP 1: DEPLOY FRESH CONTRACTS (STABLE PROFILE)           ║
╚══════════════════════════════════════════════════════════════╝

📦 Deploying fresh contracts with STABLE profile...


🚀 Running: Fresh Deployment (STABLE)
🚀 FRESH STABLE DEPLOYMENT - IGNORING ALL OLD CONTRACTS
════════════════════════════════════════════════

📋 Deployment Configuration:
  Network: kairos
  ChainId: 1001n
  Deployer: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36
  Balance: 26.047978765730837379 KAIA

📍 Network Constants:
  WKAIA: 0x0339d5Eb6D195Ba90B13ed1BCeAa97EbD198b106
  Balancer Vault: 0x1c9074AA147648567015287B0d4185Cb4E04F86d
  Treasury: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36

1️⃣ Deploying ClaimManager (non-upgradeable)...
   ✅ ClaimManager deployed at: 0xabE76832a99A798f5C7EfB1bB5c9136c5c865F58

2️⃣ Deploying SwapContract (UUPS proxy)...
   ✅ SwapContract deployed at: 0x14E5FBb1864873F59809EC041dc4b9BEc413424F

3️⃣ Deploying LPCalculations library...
   ✅ LPCalculations library deployed at: 0xb9A135aeEA2ba89c5bCDF41a13B79d95225C1ee7

4️⃣ Deploying VaultCore (UUPS proxy)...
Warning: Potentially unsafe deployment of src/VaultCore.sol:VaultCore

    You are using the `unsafeAllow.external-library-linking` flag to include external libraries.
    Make sure you have manually checked that the linked libraries are upgrade safe.

Warning: Potentially unsafe deployment of src/VaultCore.sol:VaultCore

    You are using the `unsafeAllow.delegatecall` flag.

   ✅ VaultCore deployed at: 0x9F1518D10373AF7d9BA27b23958db59eD1427202
   📊 Investment Ratio: 100% (all funds to LSTs, no buffer)

5️⃣ Deploying ShareVault (UUPS proxy)...
   ✅ ShareVault deployed at: 0x672cB6EF21C3F4c26B555f9f74454D8854849902

6️⃣ Configuring connections...
   ✅ VaultCore.setShareVault completed
   ✅ VaultCore.setClaimManager completed
   ✅ SwapContract.setAuthorizedCaller completed

7️⃣ LST tokens already configured in contract initialization
   ✅ wKoKAIA configured: true
   ✅ wGCKAIA configured: true
   ✅ wstKLAY configured: true
   ✅ stKAIA configured: true

8️⃣ Setting initial APY...
   ✅ APY set to actual production values

9️⃣ Setting investment ratios...
   ✅ Investment ratios configured:
      - Stable (LST): 100%
      - Balanced: 0%
      - Aggressive: 0%

🔟 Saving deployment addresses...
   ✅ Deployment addresses saved to deployments-stable-kairos.json

1️⃣1️⃣ Verifying deployment...
   ShareVault <-> VaultCore: ✅
   VaultCore -> SwapContract: ✅
   VaultCore -> ClaimManager: ✅
   SwapContract authorized: ✅
   APY configured: ✅
   Investment Ratios:
      Invest: 100%
      Balanced: 0%
      Aggressive: 0%

════════════════════════════════════════════════
🎉 FRESH STABLE DEPLOYMENT COMPLETE!
════════════════════════════════════════════════

📝 New Deployment Summary:
  ShareVault: 0x672cB6EF21C3F4c26B555f9f74454D8854849902
  VaultCore: 0x9F1518D10373AF7d9BA27b23958db59eD1427202
  SwapContract: 0x14E5FBb1864873F59809EC041dc4b9BEc413424F
  ClaimManager: 0xabE76832a99A798f5C7EfB1bB5c9136c5c865F58
  WKAIA: 0x0339d5Eb6D195Ba90B13ed1BCeAa97EbD198b106

📊 Investment Profile: STABLE
  Total Investment: 100%
  Stable Strategy: 100% (LST staking)
  Liquidity Buffer: 0%

💡 Next Steps:
  1. Run integration tests: npx hardhat run scripts/testIntegrated.js --network kairos
  2. Change profile if needed using setInvestmentRatios()
  3. Adjust APY distribution if needed
✅ Fresh Deployment (STABLE) completed

✅ Contracts deployed:
  ShareVault: 0x672cB6EF21C3F4c26B555f9f74454D8854849902
  VaultCore: 0x9F1518D10373AF7d9BA27b23958db59eD1427202
  SwapContract: 0x14E5FBb1864873F59809EC041dc4b9BEc413424F

╔══════════════════════════════════════════════════════════════╗
║   STEP 2: SETUP PROVIDER & FEE CONFIGURATION                ║
╚══════════════════════════════════════════════════════════════╝

🔧 Setting up wallet1 as provider...
  ✅ Added wallet1 as provider: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36

📊 Fee Configuration:
  Withdrawal Fee: 0.3% (30 basis points)
  Treasury Address: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36
  Provider (wallet1): 0xdc926E34E73292cD7c48c6fD7375af7D93435D36
  Fee Split: 1/3 to provider, 2/3 to treasury

╔══════════════════════════════════════════════════════════════╗
║   STEP 3: 3-WALLET DEPOSIT/WITHDRAW TEST (STABLE)          ║
╚══════════════════════════════════════════════════════════════╝

1️⃣ Wallet 1 - Deposit with WKAIA (0.1 KAIA)...
  🔄 Wrapping KAIA to WKAIA...
  ✅ Wrapped 0.1 KAIA to WKAIA
  🔓 Approving ShareVault to spend WKAIA...
  ✅ Approved ShareVault
  💰 Depositing WKAIA...
  ✅ Deposited 0.1 WKAIA

2️⃣ Wallet 2 - Deposit with KAIA (0.05 KAIA)...
  ✅ Deposited 0.05 KAIA

3️⃣ Wallet 3 - Deposit with KAIA (0.01 KAIA)...
  ✅ Deposited 0.01 KAIA

📊 LST Distribution Check (STABLE):
  LST 0: 0.037908700735372511 tokens
  LST 1: 0.035245641838351821 tokens
  LST 2: 0.044944532488114103 tokens
  LST 3: 0.034865293185419973 tokens

📤 Testing Withdrawals with Fees & Provider (STABLE):

💰 Initial Balances:
  Treasury: 25.599582215717752978 KAIA
  Provider (wallet1): 25.599582215717752978 KAIA

👤 Wallet 2: Withdrawing 0.05 WKAIA (100% of max) with provider...
  ✅ Withdrew with provider
  💵 Wallet2 received: 0.04985 KAIA (after 0.3% fee)
  📊 Note: 100% withdrawal should trigger 2 LST swaps (stKAIA + wGCKAIA)
  ⛽ Gas cost: 0.0191581 KAIA

👤 Wallet 3: Withdrawing 0.004997921192761068 WKAIA (50% of max, no provider)...
  ✅ Withdrew without provider
  💵 Wallet3 received: 0.004982927429182785 KAIA (after 0.3% fee)
  ⛽ Gas cost: 0.01792295 KAIA

📊 Fee Distribution Verification:
  Treasury received: 0.000164993763578283 KAIA
  Provider received: 0.000164993763578283 KAIA

  Expected fees from wallet2 (0.05 withdrawal):
    Total: 0.00015 KAIA
    Provider (1/3): 0.00005 KAIA
    Treasury (2/3): 0.0001 KAIA

  Expected fees from wallet3 (0.004997921192761068 withdrawal):
    Total: 0.000014993763578283 KAIA
    Treasury (all): 0.000014993763578283 KAIA

  ✅ Fee distribution verified:
    Provider fee match: ❌
    Treasury fee match: ❌

🔍 Verifying KAIA Distribution (not WKAIA):
  Wallet2 received KAIA directly: ✅
  Wallet3 received KAIA directly: ✅
  No WKAIA wrapping needed for users: ✅

╔══════════════════════════════════════════════════════════════╗
║   STEP 4: UNSTAKE & CLAIM TEST                              ║
╚══════════════════════════════════════════════════════════════╝

⏱️ Running unstake & claim test (takes ~11 minutes)...

🚀 Running: Unstake & Claim Test
╔══════════════════════════════════════════════════════════════╗
║          UNSTAKE/CLAIM TEST (wKoKAIA ONLY)                  ║
╚══════════════════════════════════════════════════════════════╝

Owner: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36
VaultCore: 0xf41B7e8852e7A0C1528BCaa206349119523ae9f9
WKAIA: 0x0339d5Eb6D195Ba90B13ed1BCeAa97EbD198b106
Network: KAIROS

Contract Owner: 0xdc926E34E73292cD7c48c6fD7375af7D93435D36
Is signer the owner? true

VaultCore wKoKAIA balance: 0.039832435335535541
VaultCore KoKAIA balance: 0.0

=== Unwrapping wKoKAIA to KoKAIA ===
Need to unwrap 0.003983243533553554 wKoKAIA to KoKAIA for unstaking...
Unwrap TX: 0x99a5cb26d8d42772021e04d175e413d65caaef2dd479e73e507815917b1d4488
✅ Unwrap successful
New KoKAIA balance: 0.004722531105763282

=== Step 1: Owner Unstakes KoKAIA ===
Unstaking 0.004722531105763282 KoKAIA for protocol interest...
TX: 0x79dae7043c8ebf50abcb27c5f541b52a16d0abf515c472060dcc22ee2ae7a997
✅ Unstake successful
KoKAIA balance after: 0.0

=== Step 2: Wait 10 Minutes (Testnet) ===
⏰ Waiting for claim period...
   ⏱️  10 minutes 0 seconds remaining...     ⏱️  9 minutes 56 seconds remaining...     ⏱️  9 minutes 53 seconds remaining...     ⏱️  9 minutes 50 seconds remaining...     ⏱️  9 minutes 47 seconds remaining...     ⏱️  9 minutes 44 seconds remaining...     ⏱️  9 minutes 41 seconds remaining...     ⏱️  9 minutes 38 seconds remaining...     ⏱️  9 minutes 35 seconds remaining...     ⏱️  9 minutes 32 seconds remaining...     ⏱️  9 minutes 29 seconds remaining...     ⏱️  9 minutes 26 seconds remaining...     ⏱️  9 minutes 23 seconds remaining...     ⏱️  9 minutes 20 seconds remaining...     ⏱️  9 minutes 17 seconds remaining...     ⏱️  9 minutes 14 seconds remaining...     ⏱️  9 minutes 11 seconds remaining...     ⏱️  9 minutes 8 seconds remaining...     ⏱️  9 minutes 5 seconds remaining...     ⏱️  9 minutes 2 seconds remaining...     ⏱️  8 minutes 59 seconds remaining...     ⏱️  8 minutes 56 seconds remaining...     ⏱️  8 minutes 53 seconds remaining...     ⏱️  8 minutes 50 seconds remaining...     ⏱️  8 minutes 47 seconds remaining...     ⏱️  8 minutes 44 seconds remaining...     ⏱️  8 minutes 41 seconds remaining...     ⏱️  8 minutes 38 seconds remaining...     ⏱️  8 minutes 35 seconds remaining...     ⏱️  8 minutes 32 seconds remaining...     ⏱️  8 minutes 29 seconds remaining...     ⏱️  8 minutes 26 seconds remaining...     ⏱️  8 minutes 23 seconds remaining...     ⏱️  8 minutes 20 seconds remaining...     ⏱️  8 minutes 17 seconds remaining...     ⏱️  8 minutes 14 seconds remaining...     ⏱️  8 minutes 11 seconds remaining...     ⏱️  8 minutes 8 seconds remaining...     ⏱️  8 minutes 5 seconds remaining...     ⏱️  8 minutes 2 seconds remaining...     ⏱️  7 minutes 59 seconds remaining...     ⏱️  7 minutes 56 seconds remaining...     ⏱️  7 minutes 53 seconds remaining...     ⏱️  7 minutes 50 seconds remaining...     ⏱️  7 minutes 47 seconds remaining...     ⏱️  7 minutes 44 seconds remaining...     ⏱️  7 minutes 41 seconds remaining...     ⏱️  7 minutes 38 seconds remaining...     ⏱️  7 minutes 35 seconds remaining...     ⏱️  7 minutes 32 seconds remaining...     ⏱️  7 minutes 29 seconds remaining...     ⏱️  7 minutes 26 seconds remaining...     ⏱️  7 minutes 23 seconds remaining...     ⏱️  7 minutes 20 seconds remaining...     ⏱️  7 minutes 17 seconds remaining...     ⏱️  7 minutes 14 seconds remaining...     ⏱️  7 minutes 11 seconds remaining...     ⏱️  7 minutes 8 seconds remaining...     ⏱️  7 minutes 5 seconds remaining...     ⏱️  7 minutes 2 seconds remaining...     ⏱️  6 minutes 59 seconds remaining...     ⏱️  6 minutes 56 seconds remaining...     ⏱️  6 minutes 53 seconds remaining...     ⏱️  6 minutes 50 seconds remaining...     ⏱️  6 minutes 47 seconds remaining...     ⏱️  6 minutes 44 seconds remaining...     ⏱️  6 minutes 41 seconds remaining...     ⏱️  6 minutes 38 seconds remaining...     ⏱️  6 minutes 35 seconds remaining...     ⏱️  6 minutes 32 seconds remaining...     ⏱️  6 minutes 29 seconds remaining...     ⏱️  6 minutes 26 seconds remaining...     ⏱️  6 minutes 23 seconds remaining...     ⏱️  6 minutes 20 seconds remaining...     ⏱️  6 minutes 17 seconds remaining...     ⏱️  6 minutes 14 seconds remaining...     ⏱️  6 minutes 11 seconds remaining...     ⏱️  6 minutes 8 seconds remaining...     ⏱️  6 minutes 5 seconds remaining...     ⏱️  6 minutes 2 seconds remaining...     ⏱️  5 minutes 59 seconds remaining...     ⏱️  5 minutes 56 seconds remaining...     ⏱️  5 minutes 53 seconds remaining...     ⏱️  5 minutes 50 seconds remaining...     ⏱️  5 minutes 47 seconds remaining...     ⏱️  5 minutes 44 seconds remaining...     ⏱️  5 minutes 41 seconds remaining...     ⏱️  5 minutes 38 seconds remaining...     ⏱️  5 minutes 35 seconds remaining...     ⏱️  5 minutes 32 seconds remaining...     ⏱️  5 minutes 29 seconds remaining...     ⏱️  5 minutes 26 seconds remaining...     ⏱️  5 minutes 23 seconds remaining...     ⏱️  5 minutes 20 seconds remaining...     ⏱️  5 minutes 17 seconds remaining...     ⏱️  5 minutes 14 seconds remaining...     ⏱️  5 minutes 11 seconds remaining...     ⏱️  5 minutes 8 seconds remaining...     ⏱️  5 minutes 5 seconds remaining...     ⏱️  5 minutes 2 seconds remaining...     ⏱️  4 minutes 59 seconds remaining...     ⏱️  4 minutes 56 seconds remaining...     ⏱️  4 minutes 53 seconds remaining...     ⏱️  4 minutes 50 seconds remaining...     ⏱️  4 minutes 47 seconds remaining...     ⏱️  4 minutes 44 seconds remaining...     ⏱️  4 minutes 41 seconds remaining...     ⏱️  4 minutes 38 seconds remaining...     ⏱️  4 minutes 35 seconds remaining...     ⏱️  4 minutes 32 seconds remaining...     ⏱️  4 minutes 29 seconds remaining...     ⏱️  4 minutes 26 seconds remaining...     ⏱️  4 minutes 23 seconds remaining...     ⏱️  4 minutes 20 seconds remaining...     ⏱️  4 minutes 17 seconds remaining...     ⏱️  4 minutes 14 seconds remaining...     ⏱️  4 minutes 11 seconds remaining...     ⏱️  4 minutes 8 seconds remaining...     ⏱️  4 minutes 5 seconds remaining...     ⏱️  4 minutes 2 seconds remaining...     ⏱️  3 minutes 59 seconds remaining...     ⏱️  3 minutes 56 seconds remaining...     ⏱️  3 minutes 53 seconds remaining...     ⏱️  3 minutes 50 seconds remaining...     ⏱️  3 minutes 47 seconds remaining...     ⏱️  3 minutes 44 seconds remaining...     ⏱️  3 minutes 41 seconds remaining...     ⏱️  3 minutes 38 seconds remaining...     ⏱️  3 minutes 35 seconds remaining...     ⏱️  3 minutes 32 seconds remaining...     ⏱️  3 minutes 29 seconds remaining...     ⏱️  3 minutes 26 seconds remaining...     ⏱️  3 minutes 23 seconds remaining...     ⏱️  3 minutes 20 seconds remaining...     ⏱️  3 minutes 17 seconds remaining...     ⏱️  3 minutes 14 seconds remaining...     ⏱️  3 minutes 11 seconds remaining...     ⏱️  3 minutes 8 seconds remaining...     ⏱️  3 minutes 5 seconds remaining...     ⏱️  3 minutes 2 seconds remaining...     ⏱️  2 minutes 59 seconds remaining...     ⏱️  2 minutes 56 seconds remaining...     ⏱️  2 minutes 53 seconds remaining...     ⏱️  2 minutes 50 seconds remaining...     ⏱️  2 minutes 47 seconds remaining...     ⏱️  2 minutes 44 seconds remaining...     ⏱️  2 minutes 41 seconds remaining...     ⏱️  2 minutes 38 seconds remaining...     ⏱️  2 minutes 35 seconds remaining...     ⏱️  2 minutes 32 seconds remaining...     ⏱️  2 minutes 29 seconds remaining...     ⏱️  2 minutes 26 seconds remaining...     ⏱️  2 minutes 23 seconds remaining...     ⏱️  2 minutes 20 seconds remaining...     ⏱️  2 minutes 17 seconds remaining...     ⏱️  2 minutes 14 seconds remaining...     ⏱️  2 minutes 11 seconds remaining...     ⏱️  2 minutes 8 seconds remaining...     ⏱️  2 minutes 5 seconds remaining...     ⏱️  2 minutes 2 seconds remaining...     ⏱️  1 minutes 59 seconds remaining...     ⏱️  1 minutes 56 seconds remaining...     ⏱️  1 minutes 53 seconds remaining...     ⏱️  1 minutes 50 seconds remaining...     ⏱️  1 minutes 47 seconds remaining...     ⏱️  1 minutes 44 seconds remaining...     ⏱️  1 minutes 41 seconds remaining...     ⏱️  1 minutes 38 seconds remaining...     ⏱️  1 minutes 35 seconds remaining...     ⏱️  1 minutes 32 seconds remaining...     ⏱️  1 minutes 29 seconds remaining...     ⏱️  1 minutes 26 seconds remaining...     ⏱️  1 minutes 23 seconds remaining...     ⏱️  1 minutes 20 seconds remaining...     ⏱️  1 minutes 17 seconds remaining...     ⏱️  1 minutes 14 seconds remaining...     ⏱️  1 minutes 11 seconds remaining...     ⏱️  1 minutes 8 seconds remaining...     ⏱️  1 minutes 5 seconds remaining...     ⏱️  1 minutes 2 seconds remaining...     ⏱️  0 minutes 59 seconds remaining...     ⏱️  0 minutes 56 seconds remaining...     ⏱️  0 minutes 53 seconds remaining...     ⏱️  0 minutes 50 seconds remaining...     ⏱️  0 minutes 47 seconds remaining...     ⏱️  0 minutes 44 seconds remaining...     ⏱️  0 minutes 41 seconds remaining...     ⏱️  0 minutes 38 seconds remaining...     ⏱️  0 minutes 35 seconds remaining...     ⏱️  0 minutes 32 seconds remaining...     ⏱️  0 minutes 29 seconds remaining...     ⏱️  0 minutes 26 seconds remaining...     ⏱️  0 minutes 23 seconds remaining...     ⏱️  0 minutes 20 seconds remaining...     ⏱️  0 minutes 17 seconds remaining...     ⏱️  0 minutes 14 seconds remaining...     ⏱️  0 minutes 11 seconds remaining...     ⏱️  0 minutes 8 seconds remaining...     ⏱️  0 minutes 5 seconds remaining...     ⏱️  0 minutes 2 seconds remaining...  
✅ Wait period complete!

=== Step 3: Owner Claims ===
Claiming unstaked amount...
WKAIA balance before claim: 0.215264619751396854
TX: 0x11532fa0e9c9bc176542ab425d9b258c65dfa02c46ee3d7612be4f22b919b1b2
✅ Claim successful
Claimed amount: 0.009969787889944706 KAIA
WKAIA balance after claim: 0.22523440764134156
WKAIA gained from claim: 0.009969787889944706

=== Final Verification ===
✅ Claim successful! WKAIA increased in VaultCore
   This represents staking rewards harvested for the protocol
   The WKAIA stays in VaultCore for all users' benefit

📊 Total Assets in VaultCore: 1.020870237414111039 WKAIA

✅ Unstake/Claim test complete!
✅ Unstake & Claim Test completed


╔══════════════════════════════════════════════════════════════╗
║                    TEST SUMMARY                             ║
╚══════════════════════════════════════════════════════════════╝

✅ Completed Test Steps:
  1. Fresh deployment with STABLE profile ✓
  2. Provider setup & fee configuration ✓
  3. 3-wallet deposit/withdraw test with fees ✓
  4. Unstake & claim test ✓

✅ New Features Tested:
  • Provider fee sharing (1/3 to provider, 2/3 to treasury)
  • KAIA direct distribution (no WKAIA wrapping for users)
  • 0.3% withdrawal fee collection

📊 Final Stats:
  Total Assets: 0.104953572779965131 WKAIA
  Investment Ratio: 100%
  Mode: STABLE (LST staking only)

💰 Final Wallet Balances:
  Wallet 1: 0.1 shares
  Wallet 2: 0.0 shares
  Wallet 3: 0.005 shares

🎉 STABLE MODE TEST COMPLETED SUCCESSFULLY!
